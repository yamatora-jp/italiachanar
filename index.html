<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Babylon.js WebXR AR + PLY</title>
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
</head>
<body>
  <canvas id="renderCanvas" touch-action="none"></canvas>
  <script>
    const canvas = document.getElementById("renderCanvas");
    const engine = new BABYLON.Engine(canvas, true);

    const createScene = async () => {
      const scene = new BABYLON.Scene(engine);

      const camera = new BABYLON.ArcRotateCamera("camera",
        Math.PI / 2, Math.PI / 2.5, 2, BABYLON.Vector3.Zero(), scene);
      camera.attachControl(canvas, true);

      const light = new BABYLON.HemisphericLight("light",
        new BABYLON.Vector3(0, 1, 0), scene);

      // ðŸ”¹ PLYç‚¹ç¾¤èª­ã¿è¾¼ã¿
      async function loadColoredPLY(url) {
        const response = await fetch(url);
        const text = await response.text();

        const lines = text.split("\n");
        let inHeader = true;
        let vertices = [];

        for (let line of lines) {
          if (inHeader) {
            if (line.startsWith("end_header")) {
              inHeader = false;
            }
          } else {
            if (line.trim().length === 0) continue;
            const parts = line.trim().split(/\s+/).map(Number);
            if (parts.length >= 6) {
              vertices.push({
                position: new BABYLON.Vector3(parts[0], parts[1], parts[2]),
                color: new BABYLON.Color4(parts[3] / 255, parts[4] / 255, parts[5] / 255, 1.0),
              });
            }
          }
        }

        const pcs = new BABYLON.PointsCloudSystem("pcs", { capacity: vertices.length }, scene);
        vertices.forEach(v => {
          pcs.addParticle({
            positionFunction: (p) => {
              p.position = v.position;
              p.color = v.color;
            }
          });
        });
        await pcs.buildMeshAsync();
        pcs.mesh.scaling = new BABYLON.Vector3(0.01, 0.01, 0.01);
        return pcs.mesh;
      }

      const pcsMesh = await loadColoredPLY("./gs_italiachan_ascii.ply");

      // ðŸ”¹ WebXR ARèµ·å‹•
      const xrHelper = await scene.createD
